@page "/"
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject AppDbContext DbContext
@inject AuthStatus AuthService
@using Microsoft.EntityFrameworkCore

<PageTitle>Home</PageTitle>

@if (!AuthService.IsAuthenticated)
{
    <p>Redirecting to login...</p>
    NavigationManager.NavigateTo("/login");
}
else
{
    <div>
        <h1>Marketplace</h1>
        <h2>Listings:</h2>

        <!-- Giving inputs for adding a listing -->
        <div>
            <input placeholder="Name" @bind="Name">
            <input placeholder="Price" type="number" @bind="Price">
            <button @onclick="addListing" class="add-listing">Add Listing</button>
        </div>

        <!-- Displaying all listings -->
        <ul class="listing-container">
            @if (listings != null && listings.Any())
            {
                @foreach (var listing in listings)
                {
                    <li class="listing-item">
                        <div class="listing-details">
                            <span class="listing-name">@listing.name</span>
                            <span class="listing-price">$@(listing.price).00</span>
                        </div>
                        <!-- Giving option for purchasing or deleting each listing -->
                        <button @onclick="() => purchaseListing(listing.id)" class="purchase-button">Purchase</button>
                        <button @onclick="() => removeListing(listing.id)" class="delete-button">Delete</button>
                    </li>
                }
            }
            else
            {
                <li>No Listings Available</li>
            }
        </ul>

        <!-- Confirm Delete -->
        @if (currListing != null && toDelete == true)
        {
            <p> Selected listing for deletion: @currListing.name</p>
            <p>Are you sure you want to delete @currListing.name?</p>
            <button @onclick="deleteListing" class="delete-button">Confirm</button>
            <button @onclick="cancelSelection" class="purchase-button">Cancel</button>
        }

        <!-- Confirm Purchase  -->
        @if (currListing != null && toDelete == false)
        {
            <p> Selected listing for purchase: @currListing.name</p>
            <p>Are you sure you want to purchase @currListing.name?</p>
            <button @onclick="confirmPurchase" class="purchase-button">Confirm</button>
            <button @onclick="cancelSelection" class="delete-button">Cancel</button>
        }
    </div>
}

<div>
    <button @onclick="logout" class="delete-button">Logout</button>
</div>

@code {
    private List<Listing> listings = new();
    private Listing currListing;
    private bool toDelete = false;
    private string Name;
    private int Price;

    protected override void OnInitialized()
    {
        try
        {
            // Eager loading 
            listings = DbContext.Listings.Include(l => l.user).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading listings: {ex.Message}");
        }
    }

    private void cancelSelection() {
        // Clearing the fields
        currListing = null;
        toDelete = false;
    }

    private void removeListing(int listingId) {
        // if toDelete is true then it will prompt you to confirm deletion
        findListing(listingId);
        toDelete = true;
    }

    private void purchaseListing(int listingId) {
        // if toDelete is false then it will prompt you to confirm purchase
        // if and only if currListing is also not null
        findListing(listingId);
        toDelete = false;
    }

    private void findListing(int listingId)
    {
        // Setting currListing to the current Listing object in the database
        currListing = DbContext.Listings.Include(l => l.user).FirstOrDefault(l => l.id == listingId);
    }

    private void deleteListing()
    {
        try
        {
            // Retrieving current user from db instead of using AuthService.currUser to prevent db tracking issues
            var User = DbContext.Users.FirstOrDefault(u => u.id == AuthService.currUser.id);

            // Bounds checking and ensuring only listing owner can delete their listing
            if (currListing != null && currListing.user == User)
            {
                // Removing record from database and updating database
                DbContext.Listings.Remove(currListing);
                DbContext.SaveChanges();
                listings.Remove(currListing);

                // Clearing the fields
                currListing = null;
                toDelete = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting listing: {ex.Message}");
        }
    }

    private void confirmPurchase()
    {
        try
        {
            // Bounds checking
            if (currListing != null && currListing.user != null)
            {
                // Retrieving current listing name and email for confirmation page display
                var listingName = currListing.name;
                var listingEmail = currListing.user.email;

                // Navigate user to confirmation page and pass the listing name and email as parameters
                NavigationManager.NavigateTo($"/confirmation/{listingName}/{listingEmail}");
            }
            else
            {
                Console.WriteLine("Error: The listing has no associated user.");
            }
        }
        catch (Exception ex) {
            Console.WriteLine($"Error confirming purchase: {ex.Message}");
        }
    }

    private void addListing() {
        try
        {
            // Bounds checking
            if (!string.IsNullOrWhiteSpace(Name) && Price > 0) {
                
                // Retrieving user from database rather than just using AuthService.currUser
                // This prevents database tracking conflicts that were happening earlier
                var User = DbContext.Users.FirstOrDefault(u => u.id == AuthService.currUser.id);
                
                // Bounds checking
                if (User == null)
                {
                    Console.WriteLine("Error: Current user not found.");
                    return;
                }
                
                // Creating new Listing object
                var newListing = new Listing
                {
                    name = Name,
                    price = Price,
                    user = User
                };

                // Storing new Listing object in database
                DbContext.Listings.Add(newListing);
                DbContext.SaveChanges();
                listings.Add(newListing);

                // Clearing the fields
                Name = string.Empty;
                Price = 0;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding listing: {ex.Message}");
        }
    }

    private void logout() {
        
        // Setting AuthService.currUser to null and AuthService.isAuthenticated to false
        AuthService.Logout();

        // Navigating user back to login page
        NavigationManager.NavigateTo("/login");
    }
}
